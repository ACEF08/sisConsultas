
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="EcIlsGb6pHEDJ955QBV48ZqTmPGTUFCzBJlm0oLLok8" />
    <title>Registro de Usuario</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="globals.css" rel="stylesheet">
</head>
<body class="bg-muted/40">

    <div class="flex min-h-screen w-full flex-col bg-muted/40">
        <header class="sticky top-0 z-40 flex h-16 shrink-0 items-center justify-between gap-4 border-b bg-primary-pattern px-4 text-primary-foreground shadow-md backdrop-blur-sm md:px-6">
            <div class="flex items-center gap-4">
                <img alt="Logo DIRIS Viceministerio" loading="lazy" width="200" height="35" decoding="async" data-nimg="1" class="hidden md:block" style="color:transparent" src="https://i.ibb.co/yn5DsfL2/Logo-DIRIS-Viceministerio-png.png">
            </div>
            <div class="hidden md:flex flex-1 justify-center items-center overflow-hidden">
                <h1 class="text-lg font-headline tracking-wider truncate">SISTEMA DE GESTION DE CONSULTAS TECNICAS OACEF-DMID-DIRIS/LS</h1>
            </div>
            <div class="flex items-center gap-4">
                <a class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:size-4 [&amp;_svg]:shrink-0 bg-secondary text-secondary-foreground hover:bg-secondary/80 h-10 px-4 py-2" href="/admin-login.html">
                    Acceso Personal
                </a>
            </div>
        </header>

        <main class="flex flex-1 flex-col items-center justify-center p-4 md:p-8">
            <div class="w-full max-w-xl">
                <div class="rounded-lg border bg-card text-card-foreground w-full overflow-hidden shadow-2xl">
                    <div class="bg-primary-pattern p-4">
                        <div class="flex justify-center items-center">
                            <img alt="Logo DIRIS" loading="lazy" width="56" height="56" decoding="async" data-nimg="1" class="rounded-full object-cover shadow-lg" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTDXVhFG7luDb7mBas57NUYQWeYzVErkp0-kA&s" style="color: transparent;">
                        </div>
                    </div>
                    <div class="flex flex-col space-y-1.5 p-6 text-center pt-8">
                        <div class="font-semibold tracking-tight font-headline text-2xl">Formulario de Registro</div>
                        <p class="text-sm text-muted-foreground">El DNI <span id="dni-display" class="font-bold text-primary"></span> no está registrado. Complete sus datos.</p>
                    </div>
                    <div class="p-6 pt-0">
                        <form id="register-form" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-2">
                                    <label class="text-sm font-medium leading-none" for="nombres">Nombres</label>
                                    <input class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background" placeholder="Sus nombres completos" id="nombres" name="nombres" required>
                                </div>
                                <div class="space-y-2">
                                    <label class="text-sm font-medium leading-none" for="apellidos">Apellidos</label>
                                    <input class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background" placeholder="Sus apellidos completos" id="apellidos" name="apellidos" required>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="text-sm font-medium leading-none" for="colegiatura">N° de Colegiatura (Opcional)</label>
                                <input class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background" placeholder="Ej: CQP 12345" id="colegiatura" name="colegiatura">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-2">
                                    <label class="text-sm font-medium leading-none" for="email">Correo Electrónico</label>
                                    <input class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background" placeholder="su.correo@ejemplo.com" id="email" name="email" type="email" required>
                                </div>
                                <div class="space-y-2">
                                    <label class="text-sm font-medium leading-none" for="celular">N° de Celular</label>
                                    <input class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background" placeholder="987654321" id="celular" name="celular" required>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-2">
                                    <label class="text-sm font-medium leading-none" for="password">Contraseña</label>
                                    <input class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background" placeholder="********" id="password" name="password" type="password" required>
                                </div>
                                <div class="space-y-2">
                                    <label class="text-sm font-medium leading-none" for="confirm-password">Confirmar Contraseña</label>
                                    <input class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background" placeholder="********" id="confirm-password" name="confirm-password" type="password" required>
                                </div>
                            </div>
                            <div class="flex flex-row items-start space-x-3 space-y-0 rounded-md border p-4 shadow-sm bg-muted/50">
                                <input type="checkbox" id="autorizacion" name="autorizacion" required class="peer h-4 w-4 shrink-0 rounded-sm border border-primary bg-input ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                                <div class="space-y-1 leading-none">
                                    <label for="autorizacion" class="text-sm font-medium leading-none">Autorización de Notificaciones</label>
                                    <p class="text-sm text-muted-foreground">Autorizo la notificación de los actos administrativos a través de mi correo electrónico y celular declarados.</p>
                                </div>
                            </div>
                            <button id="submit-button" class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 w-full" type="submit">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-plus mr-2 h-4 w-4"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><line x1="19" x2="19" y1="8" y2="14"></line><line x1="22" x2="16" y1="11" y2="11"></line></svg>
                                Registrarme y Continuar
                            </button>
                        </form>
                    </div>
                    <div class="flex items-center bg-muted/50 p-4">
                        <button id="back-button" class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium text-primary underline-offset-4 hover:underline h-10 px-4 py-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left mr-2 h-4 w-4"><path d="m12 19-7-7 7-7"></path><path d="M19 12H5"></path></svg>
                            Volver a la validación de DNI
                        </button>
                    </div>
                </div>
            </div>
        </main>
        <footer class="flex items-center justify-center p-4 text-sm text-muted-foreground">
            © 2026 OACEF-DMID. Todos los derechos reservados.
        </footer>
    </div>

    <script type="module">
        import { db, auth } from "./firebase-config.js";
        import { doc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        const urlParams = new URLSearchParams(window.location.search);
        const dni = urlParams.get('dni');

        if (!dni) {
            window.location.href = "index.html";
        }

        document.getElementById('dni-display').textContent = dni;

        document.getElementById('back-button').addEventListener('click', () => {
            window.location.href = 'index.html';
        });

        const registerForm = document.getElementById('register-form');
        const submitButton = document.getElementById('submit-button');
        const originalButtonHTML = submitButton.innerHTML;

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!document.getElementById('autorizacion').checked) {
                alert('Debe autorizar la notificación para poder registrarse.');
                return;
            }

            const password = registerForm.password.value;
            const confirmPassword = registerForm['confirm-password'].value;

            if (password !== confirmPassword) {
                alert('Las contraseñas no coinciden.');
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = 'Registrando...';

            const email = registerForm.email.value;
            
            try {
                // Create user with email and password
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                const userData = {
                    nombres: registerForm.nombres.value,
                    apellidos: registerForm.apellidos.value,
                    colegiatura: registerForm.colegiatura.value,
                    email: email,
                    celular: registerForm.celular.value,
                    dni: dni,
                    uid: user.uid
                };

                // Save user data to Firestore
                await setDoc(doc(db, "users", dni), userData);
                
                alert('¡Registro exitoso!');
                window.location.href = `dashboard.html?dni=${dni}`;

            } catch (error) {
                console.error("Error al registrar el usuario:", error);
                alert('Ocurrió un error durante el registro. Por favor, intente de nuevo. ' + error.message);
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonHTML;
            }
        });
    </script>

</body>
</html>
